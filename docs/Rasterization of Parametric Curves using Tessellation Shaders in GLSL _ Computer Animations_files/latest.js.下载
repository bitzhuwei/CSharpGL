!function(e){"function"==typeof define&&define.amd?define(e):e()}((function(){"use strict";const e=3,t=2,n=0,i=1,o=n,r=new URL(window.location.href).searchParams.get("aditude_debug");let s=n;switch(r){case"3":s=e;break;case"2":case"99":s=t;break;case"1":case"true":s=i;break;default:s=n}const d=(e,t={})=>{var n,i,r;const d=null!==(n=t.type)&&void 0!==n?n:"log",a=null!==(i=t.label)&&void 0!==i?i:{text:"",color:"#339933"},l=null!==(r=t.level)&&void 0!==r?r:o;return(...e)=>{l<=s&&((e,t)=>{console[e](...t)})(d,((e,t)=>{const n=[].slice.call(e),{label:i,prefix:o}=t;o&&n.unshift(o);const r=[],s=[];function d(e){return`display: inline-block; color: #fff; font-size: 9px; background: ${e}; padding: 1px 4px; border-radius: 0; margin-right: 1px;`}return s.push("%ctudeserve"),i.text.length>0&&s.push(`%c${i.text}`),i.text.length>0&&r.push(d(i.color)),r.push(d("green")),r.forEach((e=>{n.unshift(e)})),n.unshift(s.join("")),n})(e,{prefix:"",label:a}))}},a=d(0,{label:{text:"log",color:"#61B321"},level:i}),l=d(0,{type:"error",label:{text:"error",color:"red"},level:i}),c=d(0,{label:{text:"verbose",color:"#61B321"},level:e});function u(e,t,n,i){return new(n||(n=Promise))((function(o,r){function s(e){try{a(i.next(e))}catch(e){r(e)}}function d(e){try{a(i.throw(e))}catch(e){r(e)}}function a(e){var t;e.done?o(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(s,d)}a((i=i.apply(e,t||[])).next())}))}function h(e,t,n,i){if("a"===n&&!i)throw new TypeError("Private accessor was defined without a getter");if("function"==typeof t?e!==t||!i:!t.has(e))throw new TypeError("Cannot read private member from an object whose class did not declare it");return"m"===n?i:"a"===n?i.call(e):i?i.value:t.get(e)}function m(e,t,n,i,o){if("m"===i)throw new TypeError("Private method is not writable");if("a"===i&&!o)throw new TypeError("Private accessor was defined without a setter");if("function"==typeof t?e!==t||!o:!t.has(e))throw new TypeError("Cannot write private member to an object whose class did not declare it");return"a"===i?o.call(e,n):o?o.value=n:t.set(e,n),n}"function"==typeof SuppressedError&&SuppressedError;class p{constructor(e){var t,n,i;this.currency="USD",this.slotId=e.slotId,this.bidder=null!==(t=e.bidder)&&void 0!==t?t:e.source,this.source=e.source,this.amount=e.amount,this.mediaType=null!==(n=e.mediaType)&&void 0!==n?n:"unknown",this.sourceData=e.sourceData,this.currency=null!==(i=e.currency)&&void 0!==i?i:"USD",c("Bid created",this)}toJson(){return{slotId:this.slotId,source:this.source,bidder:this.bidder,amount:this.amount,currency:this.currency,mediaType:this.mediaType,sourceData:this.sourceData}}}var f;class v{constructor(e,t,n,i,o=!0){this.adUnit=e,this.elementId=t,this.sizes=n,this.keyValues=i,this.safeframe=o,f.set(this,[]),a("Slot created",this)}getElement(){return document.getElementById(this.elementId)}get bids(){return h(this,f,"f")}set bids(e){c("setting bids to slot",{slot:this,bids:e}),m(this,f,e,"f")}clearBids(){m(this,f,[],"f")}}f=new WeakMap;const w=(e,t)=>new CustomEvent(`tudeserve_${e}`,{detail:t}),g=(e,t)=>{e.dispatchEvent(t),c(`event:${t.type.replace("tudeserve_","")} dispatched`,t.detail)};class b{on(e,t){window.addEventListener(`tudeserve_${e}`,(e=>{t(e.detail)})),c(`event:${e} listener registered`)}}const y=(e,t,n)=>{let i,o=0;new IntersectionObserver(((e,r)=>{e.forEach((e=>{e.isIntersecting?i=setInterval((()=>{o+=100,o>1e3&&(g(window,w("viewable",{slot:t,bid:n})),r.unobserve(e.target),clearInterval(i))}),100):clearInterval(i)}))}),{root:null,rootMargin:"0px 0px 0px 0px",threshold:.5}).observe(e)};let S;const E=new Uint8Array(16);function T(){if(!S&&(S="undefined"!=typeof crypto&&crypto.getRandomValues&&crypto.getRandomValues.bind(crypto),!S))throw new Error("crypto.getRandomValues() not supported. See https://github.com/uuidjs/uuid#getrandomvalues-not-supported");return S(E)}const k=[];for(let e=0;e<256;++e)k.push((e+256).toString(16).slice(1));var A={randomUUID:"undefined"!=typeof crypto&&crypto.randomUUID&&crypto.randomUUID.bind(crypto)};function I(e,t,n){if(A.randomUUID&&!t&&!e)return A.randomUUID();const i=(e=e||{}).random||(e.rng||T)();return i[6]=15&i[6]|64,i[8]=63&i[8]|128,function(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0;return k[e[t+0]]+k[e[t+1]]+k[e[t+2]]+k[e[t+3]]+"-"+k[e[t+4]]+k[e[t+5]]+"-"+k[e[t+6]]+k[e[t+7]]+"-"+k[e[t+8]]+k[e[t+9]]+"-"+k[e[t+10]]+k[e[t+11]]+k[e[t+12]]+k[e[t+13]]+k[e[t+14]]+k[e[t+15]]}(i)}class D{constructor(){this.timings={}}addTiming(e,t){this.timings[e]=null!=t?t:Date.now()}getTiming(e){return this.timings[e]}}class x{constructor(e){this.results=[],this.slots=[],this.tt=new D,this.status="init",this.id=I(),this.slots=null!=e?e:[],this.logTiming("init"),c("Request created",this)}nextStep(){switch(this.status){case"init":this.status="requested",this.logTiming("requested");break;case"requested":this.status="complete",this.logTiming("complete");break;default:l("Request already ended",this)}}addResult(e){this.results.push(e)}logTiming(e){this.tt.addTiming(e)}getTimings(){const e=this.tt.getTiming("init"),t=this.tt.getTiming("requested"),n=this.tt.getTiming("complete");return{startToRequest:t&&e?t-e:null,requestToComplete:n&&t?n-t:null,startToComplete:n&&e?n-e:null}}}const R=e=>{const t=document.createElement("iframe");return t.id=`tudeserve-frame--${e.elementId}`,t.name=t.id,t.setAttribute("width","1"),t.setAttribute("height","1"),t.setAttribute("scrolling","no"),t.setAttribute("frameBorder","0"),t.style.background="#fff",t.sandbox.add("allow-forms","allow-pointer-lock","allow-popups","allow-popups-to-escape-sandbox","allow-same-origin","allow-scripts","allow-top-navigation-by-user-activation","allow-presentation"),t};function j(e){if(e&&"createElement"in e&&"head"in e){const t=e.createElement("style");t.appendChild(e.createTextNode("html,body {padding:0;margin:0;}")),e.head.appendChild(t)}}function $(e,t,n){const i=document.createElement("script");t&&(i.onload=()=>t(!0)),n&&(i.onerror=e=>n(e)),i.async=!1,i.src=e,document.head.appendChild(i)}class _{static getSafeframeApi(){return u(this,void 0,void 0,(function*(){return this.promise||(this.promise=this.load()),this.promise}))}static load(){return u(this,void 0,void 0,(function*(){var e,t;const n=["https://edge.aditude.io/safeframe/1-1-1/js/lib/base.js","https://edge.aditude.io/safeframe/1-1-1/js/host/host.js","https://edge.aditude.io/safeframe/1-1-1/js/lib/boot.js"];n.forEach((e=>{const t=document.createElement("link");t.rel="preload",t.as="script",t.href=e,document.head.appendChild(t)}));for(const e of n)yield new Promise(((t,n)=>{$(e,t,n)}));null===(t=null===(e=window.$sf)||void 0===e?void 0:e.host)||void 0===t||t.Config({renderFile:"https://edge.aditude.io/safeframe/1-1-1/html/container.html",auto:!1,debug:!0,positions:{},supports:{"exp-ovr":0,"exp-push":0,bg:0,pin:0,"read-cookie":0,"write-cookie":0}});const i=document.createElement("style");return i.textContent=".tudeserve-wrap .iab_sf { display: inline-block; }",document.head.appendChild(i),window.$sf}))}}function B(){return u(this,void 0,void 0,(function*(){return _.getSafeframeApi()}))}function C(e){e=e||{};const t={};try{Object.keys(e).forEach((n=>{const i=e[n];(i||"0"===String(i))&&(Array.isArray(i)&&i.length?t[n]=i.map(String):t[n]=[String(i)])}))}catch(e){}return t}function U(e){const t=document.location.href,n=C(e);return`<script>\n    var kvBidObject = {\n        kvMap: ${JSON.stringify(n)},\n        url: ${JSON.stringify(t)},\n        bidType: "openAuction",\n        cv: "v3.0.1"\n    };\n\n    function _apstagRenderCallback(a) {\n        for (var e = window, n = 0; n < 5;) {\n            if ((e = a.ampEnv || a.sfEnv ? window : e.parent).apstag) try {\n                n = 5, e.apstag.renderImp(document, "", a)\n            } catch (a) {}\n            n++\n        }\n    }\n\n    function _isAmp() {\n        return window.AMP_CONTEXT_DATA && "AMP-AD" === window.AMP_CONTEXT_DATA.tagName\n    }\n\n    function _isSf() {\n        try {\n            return window.$sf && typeof window.$sf.ext !== "undefined"\n        } catch (e) {\n            return false\n        }\n    }\n    kvBidObject.ampEnv = _isAmp();\n    kvBidObject.sfEnv = _isSf();\n    if (kvBidObject.ampEnv || kvBidObject.sfEnv) {\n        var apstagUrl = "//c.amazon-adsystem.com/aax2/apstag.js",\n            s = document.createElement("script");\n        s.onload = function() {\n            _apstagRenderCallback(kvBidObject)\n        }, s.src = apstagUrl, window.document.head.appendChild(s)\n    } else _apstagRenderCallback(kvBidObject);\n  <\/script>\n  `}const O=window._tudePbjsGlobal||"pbjs";window[O]=window[O]||{que:[]},window[O].que=window[O].que||[];const q=window[O];function z(e){var t,n;const i=document.location.href,o=String((null===(t=null==e?void 0:e.adserverTargeting)||void 0===t?void 0:t.hb_format)||(null==e?void 0:e.mediaType))||"creative",r=C(null==e?void 0:e.adserverTargeting);return`\n    <script src="https://cdn.jsdelivr.net/npm/prebid-universal-creative@latest/dist/${o}.js"><\/script>\n    <script>\n        const ucTagData = {\n          adServerDomain: '',\n          pubUrl: ${JSON.stringify(i)},\n          targetingMap: ${JSON.stringify(r)},\n          hbPb: ${JSON.stringify(null===(n=null==e?void 0:e.adserverTargeting)||void 0===n?void 0:n.hb_pb)},\n        };\n\n        try {\n            ucTag.renderAd(document, ucTagData);\n        } catch (e) {\n            console.log(e);\n        }\n    <\/script>\n  `}function P(e,t,n){c("building creative",{demandSource:e,slot:t,bid:n});if(!t.getElement())return l("Slot element not found"),!1;const i=document.createElement("div");i.classList.add("tudeserve-wrap"),i.style.textAlign="center",i.id=`tudeserve-slot--${t.elementId}`;try{let o;switch(e){case"amazon":c("rendering amazon ad",{slot:t,bid:n}),o=function(e,t,n){const i=encodeURIComponent(window.location.href),o={kvMap:C(n),url:i,bidType:"openAuction",cv:"v2.0.0"},r=R(e);return e.safeframe?B().then((t=>u(this,void 0,void 0,(function*(){yield new Promise((e=>setTimeout((()=>e(!0)),0)));let i=n.size||n.amznsz;const o=(e.sizes||[]).filter((e=>Array.isArray(e))).map((e=>e.join("x")));o.find((e=>e===i))||(i=(null==o?void 0:o[0])||"1x1");const s=t.host.PosConfig({id:e.elementId,dest:r.id,size:i,tgt:"_blank",supports:{"exp-ovr":0,"exp-push":0,bg:0,pin:0,"read-cookie":0,"write-cookie":0}}),d=t.host.Position({id:s.id,html:U(n)});t.host.render(d)})))):setTimeout((()=>{var e,t;null===(t=null===(e=window.apstag)||void 0===e?void 0:e.renderImp)||void 0===t||t.call(e,r.contentDocument,n.amzniid,o),j(r.contentDocument)})),r}(t,0,n.sourceData);break;case"prebid":c("rendering prebid ad",{slot:t,bid:n}),o=function(e,t,n){const i=R(e);return e.safeframe?B().then((t=>u(this,void 0,void 0,(function*(){yield new Promise((e=>setTimeout((()=>e(!0)),0)));let o=n.width,r=n.height;if(!e.sizes.find((e=>e[0]===n.width&&e[1]===n.height))){const t=e.sizes.find((e=>Array.isArray(e)));t?(o=t[0],r=t[1]):(o=1,r=1)}const s=t.host.PosConfig({id:e.elementId,dest:i.id,w:o,h:r,tgt:"_blank",supports:{"exp-ovr":0,"exp-push":0,bg:0,pin:0,"read-cookie":0,"write-cookie":0}}),d=t.host.Position({id:s.id,html:z(n)});t.host.render(d)})))):setTimeout((()=>{q.que.push((()=>{q.renderAd(i.contentDocument,n.adId),j(i.contentDocument)}))})),i}(t,0,n.sourceData);break;default:return l("Unknown demand source to render: ",e),!1}return i.appendChild(o),i}catch(e){return l(e),!1}}const N={createBid:e=>new p(e),createRequest:e=>new x(e)};class M{constructor(){this.slots=[]}add(e,t,n,i,o=!1){return this.updateOrCreate(e,t,n,i,o)}updateOrCreate(e,t,n,i,o=!1){let r=this.slots.find((e=>e.elementId===t));return n=(n||[]).filter((e=>Array.isArray(e)&&2===e.length)),r?(r.adUnit!==e&&(r.adUnit=e),r.sizes=n,r.keyValues=i,r.safeframe=o):(r=new v(e,t,n,i,o),this.slots.push(r)),r}getSlots(){return this.slots}getSlotByElementId(e){return this.slots.find((t=>t.elementId===e))}getSlotByAdUnit(e){return this.slots.find((t=>t.adUnit===e))}getSlotBySize(e,t){return this.slots.find((n=>n.sizes.some((n=>n[0]===e&&n[1]===t))))}}class L{constructor(){this.slotsService=new M,c("AdsService created")}factory(){return N}get slots(){return this.slotsService}request(e){c("Request start",e),(e=>{if(e){if(!Array.isArray(e))throw l("Slot inputs must be an array of Slot objects or element ID strings",e),new Error("Slot inputs must be an array of Slot objects or element ID strings");for(const t of e)if(!("string"==typeof t||"object"==typeof t&&t instanceof v))throw l("Slot inputs must be an array of Slot objects or element ID strings",e),new Error("At least one of the slot inputs is not a Slot object or element ID string")}c("valid request input",e)})(e);const t=new x(e);if(c("Requesting slots: ",t.slots),0===t.slots.length)return void l("No slots to request",t);const n=t.slots.filter((e=>{if("string"==typeof e){return!!this.slotsService.getSlotByElementId(e)||(l("Slot not found: ",e),t.addResult(`#${e} > outcome:slot_not_found`),!1)}return e instanceof v||(l("Invalid slot object: ",e),!1)})).map((e=>"string"==typeof e?this.slotsService.getSlotByElementId(e):e));t.nextStep(),n.forEach((e=>{g(window,w("request",{slot:e}));if(!e.getElement())return l("Slot element not found"),void t.addResult(`#${e.elementId} > outcome:sloterror`);const n=function(e){if(0!==e.length)return e.filter((e=>"number"==typeof e.amount&&e.amount>0)).reduce(((e,t)=>t.amount>e.amount?t:e),e[0])}(e.bids);if(!n)return l("No bid found for slot: ",e),g(window,w("no_bid",{slot:e})),void t.addResult(`#${e.elementId} > outcome:no_bid`);g(window,w("bid_won",{bid:n,slot:e}));const i=`#${e.elementId} > source:${n.source}, bidder:${n.bidder}, amt:${n.amount.toFixed(5)} > outcome:`;try{const o=this.render(n,e);return o?t.addResult(`${i}:rendered`):t.addResult(`${i}:error`),o}catch(e){t.addResult(`${i}:error`),l("Failed to render ad",e)}})),t.nextStep(),t.results.forEach((e=>{a(e)})),a("request complete",t.getTimings())}markBidRendered(e,t){setTimeout((()=>{var n,i,o,r,s;if("prebid"===e.source&&"status"in e.sourceData&&(e.sourceData.status="rendered"),"amazon"===e.source&&"amzniid"in e.sourceData)try{const d=e.sourceData.amzniid,a=null!==(r=null===(o=null===(i=null===(n=window.apstag)||void 0===n?void 0:n.debug("getState"))||void 0===i?void 0:i.slotBids)||void 0===o?void 0:o[t.elementId])&&void 0!==r?r:[],l=null===(s=null==a?void 0:a.find)||void 0===s?void 0:s.call(a,(e=>{var t;return(null===(t=null==e?void 0:e.bidObject)||void 0===t?void 0:t.amzniid)===d}));l&&(l.bidState="RENDERED")}catch(e){}}),100)}render(e,t){c("Render start",{slot:t,bid:e}),g(window,w("render_start",{bid:e,slot:t}));const n=t.getElement();if(!n)return l("Slot element not found"),t.clearBids(),!1;const{source:i}=e,o=P(i,t,e);if(!o)return l("Failed to build creative"),t.clearBids(),!1;if(n.innerHTML="",n.appendChild(o),"video"===e.mediaType){let i,o;const r=()=>{n.removeEventListener("AD_PROGRESS",i),n.removeEventListener("AD_ERROR",o)};o=()=>{r(),t.clearBids(),l(`vast error: ${e.bidder}, ${t.elementId}`)},i=()=>{r(),g(window,w("impression",{bid:e,slot:t})),t.clearBids(),y(n,t,e)},n.addEventListener("AD_PROGRESS",i),n.addEventListener("AD_ERROR",o)}else this.markBidRendered(e,t),g(window,w("impression",{bid:e,slot:t})),t.clearBids(),y(n,t,e);return c("Render end",{slot:t,bid:e}),t}}var J,V,F,G,W;J=new WeakMap,V=new WeakMap;const X="tudeserve";window[X]=null!==(F=window[X])&&void 0!==F?F:{cmd:[]},window[X].cmd=null!==(G=window[X].cmd)&&void 0!==G?G:[];const H=window[X].cmd;a(`TudeServe SDK v${null!==(W="0.0.73")?W:"0"} loaded.`);const K=new class{constructor(e=[]){J.set(this,void 0),V.set(this,void 0),m(this,J,new L,"f"),m(this,V,new b,"f"),this.cmd=e||[],this.cmd.push=e=>{e(this)},a("TudeServe created",this)}ads(){return h(this,J,"f")}events(){return h(this,V,"f")}}(H);c("current window.tudeserve",window[X]);let Q=[];void 0!==window[X]&&("object"!=typeof window[X]||Array.isArray(window[X])||void 0!==window[X].cmd&&Array.isArray(window[X].cmd)&&(Q=[...window[X].cmd],window[X].cmd.length=0)),c(`triggering queue of ${Q.length.toString()} commands`),Q.forEach((e=>K.cmd.push(e))),window[X]=K}));
