var wpFollow;(function(o){var l;window._tkq=window._tkq||[];wpFollow={version:"1382729516",lang:"en",jsonAPIbase:"https://public-api.wordpress.com/rest/v1",hasUpgradedProxy:false,isLoggedIn:false,APIqueue:[],cache:[],batchFinished:true,batchWaiting:[],me:false,blogInfo:{},isFollowing:false,showFollowerCount:false,showBlogName:true,pendingAction:"",i18n:false,wpFollow:function(){wpFollow.query=wpFollow.splitParams(location.hash.replace(/^#/,""));if(undefined!==wpFollow.query.lang){wpFollow.lang=wpFollow.query.lang}if(undefined!==wpFollow.query.show_follower_count){wpFollow.showFollowerCount=wpFollow.query.show_follower_count=="true"||wpFollow.query.show_follower_count=="yes"?true:false}if(undefined!==wpFollow.query.show_blog_name){wpFollow.showBlogName=wpFollow.query.show_blog_name=="true"||wpFollow.query.show_blog_name=="yes"?true:false}wpFollow.loadTranslation();wpFollow.getBatchData(wpFollow.query.blog,wpFollow.displayWidget)},followBlog:function(o,l,e){wpFollow.bumpStat("blog_follow");return this.ajax({type:"POST",path:"/sites/"+encodeURIComponent(o)+"/follows/new",success:l,error:e})},unfollowBlog:function(o,l,e){wpFollow.bumpStat("blog_unfollow");return this.ajax({type:"POST",path:"/sites/"+encodeURIComponent(o)+"/follows/mine/delete",success:l,error:e})},doFollow:function(o){if(!wpFollow.isLoggedIn){wpFollow.pendingAction=wpFollow.isFollowing?"unfollow":"follow";wpFollow.openLoginWindow();return}if(false==wpFollow.isFollowing){wpFollow.followBlog(o,function(o){wpFollow.isFollowing=true;++wpFollow.blogInfo.subscribers_count;wpFollow.updateWidget()})}else if(true==wpFollow.isFollowing){wpFollow.unfollowBlog(o,function(o){wpFollow.isFollowing=false;--wpFollow.blogInfo.subscribers_count;wpFollow.updateWidget()})}},splitParams:function(o){var l={};jQuery.each(o.split("&"),function(o,e){var n=e.split("=");l[n[0]]=decodeURIComponent(n[1])});return l},ajax:function(o){var l={path:o.path,method:o.type,url:wpFollow.jsonAPIbase+o.path};if(!wpFollow.batchFinished&&"/batch"!==o.path){wpFollow.batchWaiting.push(o);return}if("undefined"==typeof o.fromCache)o.fromCache=true;if(o.path in wpFollow.cache&&o.fromCache){"function"==typeof o.success&&o.success(wpFollow.cache[o.path],o.path);return}if(o.type.toLowerCase()=="post"){l.body=o.data;l.query=o.query}else{l.query=o.data}var e={event:"ajax",request:l};var n=function(){return jQuery.wpcom_proxy_request(l,function(e,n){if(200==n)"function"==typeof o.success&&o.success(e,l.path);else"function"==typeof o.error&&o.error(n,l.path)})};if(wpFollow.hasUpgradedProxy){return n()}else{return jQuery.wpcom_proxy_request({metaAPI:{accessAllUsersBlogs:true}}).done(function(){wpFollow.hasUpgradedProxy=true;n()})}},postMessage:function(o,l,e){if("string"===typeof o){try{o=JSON.parse(o)}catch(o){return}}if("undefined"==typeof e){e="followMessage"}pm({target:l,type:e,data:o})},openLoginWindow:function(){if(l){if(!l.closed){l.close()}l=false}o("#wp-login-polling-iframe").remove();wpFollow.clearIdentity();var e="//wordpress.com/public.api/connect/?action=request&service=wordpress";l=window.open(e,"likeconn","status=0,toolbar=0,location=1,menubar=0,directories=0,resizable=1,scrollbars=1,height=500,width=1000");var n=o("<iframe id='wp-login-polling-iframe'></iframe>");n.attr("src","//wordpress.com/public.api/connect/?iframe=true");n.css("display","none");o(document.body).append(n);wpFollow.bumpStat("login_window_open")},loadTranslation:function(){var o=true;if("en"!=wpFollow.lang){var l;jQuery.ajax({url:"/languages/"+wpFollow.lang+".json"+"?ver="+wpFollow.version,dataType:"json",async:false,success:function(e){l=e;o=false}})}if(null==l)o=true;if(o){var l={"":{"domain":"messages","lang":wpFollow.lang,"plural-forms":"nplurals=2; plural=(n != 1);"}}}wpFollow.i18n=new Jed({locale_data:{"messages":l},"domain":"messages"})},getBatchData:function(o,l){o=encodeURIComponent(o);wpFollow.APIqueue.push("/me");wpFollow.APIqueue.push("/sites/"+o);wpFollow.APIqueue.push("/sites/"+o+"/follows/mine");var e={path:"/batch",type:"GET",url:"//public-api.wordpress.com/rest/v1/batch",data:{urls:wpFollow.APIqueue},success:function(e){for(var n in e){if(!e[n]["error_data"]&&!e[n]["errors"]){if("/me"==n){wpFollow.me=e[n];wpFollow.isLoggedIn=true;wpFollow.identifyUser()}else if("/sites/"+o==n){wpFollow.blogInfo=e[n]}else if("/sites/"+o+"/follows/mine"==n){wpFollow.isFollowing=e[n].is_following}else{continue}}}l()},error:function(o){console.log("batch loading error")}};wpFollow.ajax(e)},readMessage:function(e){var n=e.data;if("undefined"==typeof n.event)return;if("login"==n.event&&n.success){if(l){if(!l.closed){l.close()}l=false}o("#wp-login-polling-iframe").remove();wpFollow.isLoggedIn=true;wpFollow.hasUpgradedProxy=false;o.wpcom_proxy_rebuild();wpFollow.bumpStat("login_success");wpFollow.getBatchData(wpFollow.query.blog,function(){if(wpFollow.pendingAction==="follow"&&!wpFollow.isFollowing){wpFollow.doFollow(wpFollow.blogInfo.URL)}else{wpFollow.updateWidget()}wpFollow.pendingAction=""})}},displayWidget:function(){var o=document.createElement("link");o.setAttribute("type","text/css");o.setAttribute("rel","stylesheet");o.setAttribute("href","//widgets.wp.com/follow/style.css?ver="+wpFollow.version);jQuery(document).find("head")[0].appendChild(o);if(undefined!==wpFollow.blogInfo.URL)wpFollow.updateWidget()},updateWidget:function(){var o=wpFollow.isFollowing?"following":"follow";var l=wpFollow.i18n.translate(o.charAt(0).toUpperCase()+o.slice(1)).fetch();if(wpFollow.showBlogName)l+=" "+wpFollow.blogInfo.name;var e=jQuery("#wordpress-follow-button").html();jQuery("body").find("#target").html(_.template(e)({following:o,label:l,show_follower_count:wpFollow.showFollowerCount,subscribers_count:wpFollow.blogInfo.subscribers_count.toString().replace(/\B(?=(\d{3})+(?!\d))/g,",")}));jQuery(document).find(".wordpress-follow-button a").click(function(o){o.preventDefault();if(o.originalEvent.detail===0){return}wpFollow.bumpStat("follow_button_click");wpFollow.doFollow(wpFollow.blogInfo.URL)})},identifyUser:function(){window._tkq.push(["identifyUser",wpFollow.me.ID,wpFollow.me.username])},clearIdentity:function(){window._tkq.push(["clearIdentity"])},bumpStat:function(o){var l={blog_id:wpFollow.blogInfo.ID,is_following:wpFollow.isFollowing,is_logged_in:wpFollow.isLoggedIn};window._tkq.push(["recordEvent","wpcom_follow_widget_"+o,l])}};wpFollow.wpFollow();window.addEventListener("message",function(o){var l=o&&o.data;if(typeof l==="string"){try{l=JSON.parse(l)}catch(o){return}}var e=l&&l.type;if(e==="loginMessage"){wpFollow.readMessage(l)}})})(jQuery);